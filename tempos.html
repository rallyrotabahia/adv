<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>Cronometragem - Rally</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a202c; color: white; display: flex; justify-content: center; padding: 20px; }
        .card { background: #2d3748; padding: 25px; border-radius: 12px; width: 100%; max-width: 400px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h2 { color: #ed8936; text-align: center; }
        label { display: block; margin-bottom: 5px; font-size: 14px; color: #a0aec0; }
        select, input, button { width: 100%; padding: 12px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #4a5568; background: #1a202c; color: white; box-sizing: border-box; }
        button { background: #38a169; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; }
        button:hover { background: #2f855a; }
        .res { background: #1a202c; padding: 10px; border-radius: 4px; text-align: center; border: 1px dashed #ed8936; }
    </style>
</head>
<body>
    <div class="card">
        <h2>‚è±Ô∏è Registro de Prova</h2>
        
        <label>Competidor:</label>
        <select id="carSelect"><option>Carregando...</option></select>

        <label>Hora de Largada:</label>
        <input type="time" id="horaLargada" step="1">

        <label>Hora de Chegada:</label>
        <input type="time" id="horaChegada" step="1">

        <button onclick="salvarTempo()">SALVAR E CALCULAR</button>

        <div id="resultadoBusca" class="res">Tempo total: --:--:--</div>
        
        <button style="background:#4a5568; margin-top:15px;" onclick="location.href='ranking-tempo.html'">üèÜ VER RANKING DE TEMPO</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBPJkehV9C1x0hiY5dQSwSRtVf5c4P2JGE",
            authDomain: "cronometro-rally.firebaseapp.com",
            databaseURL: "https://cronometro-rally-default-rtdb.firebaseio.com",
            projectId: "cronometro-rally",
            appId: "1:341731891354:web:d0c34265be68015e98a723"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Carregar competidores
        db.ref('competidores').on('value', snap => {
            let opt = '<option value="">Selecione...</option>';
            snap.forEach(c => { opt += `<option value="${c.key}">${c.key} - ${c.val().nome}</option>`; });
            document.getElementById('carSelect').innerHTML = opt;
        });

        function salvarTempo() {
            const id = document.getElementById('carSelect').value;
            const largada = document.getElementById('horaLargada').value;
            const chegada = document.getElementById('horaChegada').value;

            if(!id || !largada || !chegada) return alert("Preencha tudo!");

            const t1 = new Date(`2000-01-01T${largada}`);
            const t2 = new Date(`2000-01-01T${chegada}`);
            
            let diffMs = t2 - t1;
            if (diffMs < 0) diffMs += 86400000; // Caso vire a noite

            const tempoFormatado = new Date(diffMs).toISOString().substr(11, 8);
            
            db.ref(`competidores/${id}`).update({
                horaLargada: largada,
                horaChegada: chegada,
                tempoTotalMs: diffMs,
                tempoFormatado: tempoFormatado
            }).then(() => {
                document.getElementById('resultadoBusca').innerText = "Tempo total: " + tempoFormatado;
                alert("Tempo salvo com sucesso!");
            });
        }
    </script>
</body>
</html>
